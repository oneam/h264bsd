window=this;function H264bsdDecoder(module){this.module=module;this.released=false;this.pInput=0;this.inputLength=0;this.inputOffset=0;this.onPictureReady=null;this.onHeadersReady=null;this.pStorage=module._h264bsdAlloc();module._h264bsdInit(this.pStorage,0)}H264bsdDecoder.RDY=0;H264bsdDecoder.PIC_RDY=1;H264bsdDecoder.HDRS_RDY=2;H264bsdDecoder.ERROR=3;H264bsdDecoder.PARAM_SET_ERROR=4;H264bsdDecoder.MEMALLOC_ERROR=5;H264bsdDecoder.NO_INPUT=1024;H264bsdDecoder.prototype.release=function(){var module=this.module;var pStorage=this.pStorage;var pInput=this.pInput;if(pStorage!=0){module._h264bsdShutdown(pStorage);module._h264bsdFree(pStorage)}if(pInput!=0){module._free(pInput)}this.pStorage=0;this.pInput=0;this.inputLength=0;this.inputOffset=0};H264bsdDecoder.prototype.queueInput=function(data){var module=this.module;var pInput=this.pInput;var inputLength=this.inputLength;var inputOffset=this.inputOffset;if(data instanceof ArrayBuffer){data=new Uint8Array(data)}if(pInput===0){inputLength=data.byteLength;pInput=module._malloc(inputLength);inputOffset=0;module.HEAPU8.set(data,pInput)}else{var remainingInputLength=inputLength-inputOffset;var newInputLength=remainingInputLength+data.byteLength;var pNewInput=module._malloc(newInputLength);module._memcpy(pNewInput,pInput+inputOffset,remainingInputLength);module.HEAPU8.set(data,pNewInput+remainingInputLength);module._free(pInput);pInput=pNewInput;inputLength=newInputLength;inputOffset=0}this.pInput=pInput;this.inputLength=inputLength;this.inputOffset=inputOffset;this.decode()};H264bsdDecoder.prototype.inputBytesRemaining=function(){return this.inputLength-this.inputOffset};H264bsdDecoder.prototype.decode=function(){try{var module=this.module;var pStorage=this.pStorage;var pInput=this.pInput;var inputLength=this.inputLength;var inputOffset=this.inputOffset;if(pInput==0){postMessage({statusCode:H264bsdDecoder.NO_INPUT});return}setTimeout(function(){this.decode()}.bind(this),0);var pBytesRead=module._malloc(4);var bytesRead=0;var retCode=module._h264bsdDecode(pStorage,pInput+inputOffset,inputLength-inputOffset,0,pBytesRead);if(retCode==3||retCode==4||retCode==5)bytesRead=0;else bytesRead=module.getValue(pBytesRead,"i32");module._free(pBytesRead);inputOffset+=bytesRead;if(inputOffset>=inputLength){module._free(pInput);pInput=0;inputOffset=0;inputLength=0}this.pInput=pInput;this.inputLength=inputLength;this.inputOffset=inputOffset;if(retCode==H264bsdDecoder.PIC_RDY){var buf=this.nextOutputPicture();postMessage(buf.buffer,[buf.buffer])}else if(retCode==H264bsdDecoder.HDRS_RDY){postMessage({statusCode:retCode,croppingParams:this.croppingParams(),decoderWidth:this.outputPictureWidth(),decoderHeight:this.outputPictureHeight()})}else{postMessage({statusCode:retCode})}}catch(e){postMessage({statusCode:H264bsdDecoder.ERROR})}};H264bsdDecoder.prototype.nextOutputPicture=function(){var module=this.module;var pStorage=this.pStorage;var pPicId=module._malloc(4);var pIsIdrPic=module._malloc(4);var pNumErrMbs=module._malloc(4);var pBytes=module._h264bsdNextOutputPicture(pStorage,pPicId,pIsIdrPic,pNumErrMbs);module._free(pPicId);module._free(pIsIdrPic);module._free(pNumErrMbs);var outputLength=this.outputPictureSizeBytes();var outputBytes=new Uint8Array(module.HEAPU8.subarray(pBytes,pBytes+outputLength));return outputBytes};H264bsdDecoder.prototype.nextOutputPictureRGBA=function(){var module=this.module;var pStorage=this.pStorage;var pPicId=module._malloc(4);var pIsIdrPic=module._malloc(4);var pNumErrMbs=module._malloc(4);var pBytes=module._h264bsdNextOutputPictureRGBA(pStorage,pPicId,pIsIdrPic,pNumErrMbs);module._free(pPicId);module._free(pIsIdrPic);module._free(pNumErrMbs);var outputLength=this.outputPictureSizeBytesRGBA();var outputBytes=new Uint8Array(module.HEAPU8.subarray(pBytes,pBytes+outputLength));return outputBytes};H264bsdDecoder.prototype.outputPictureWidth=function(){var module=this.module;var pStorage=this.pStorage;return module._h264bsdPicWidth(pStorage)*16};H264bsdDecoder.prototype.outputPictureHeight=function(){var module=this.module;var pStorage=this.pStorage;return module._h264bsdPicHeight(pStorage)*16};H264bsdDecoder.prototype.outputPictureSizeBytes=function(){var width=this.outputPictureWidth();var height=this.outputPictureHeight();return width*height*3/2};H264bsdDecoder.prototype.outputPictureSizeBytesRGBA=function(){var width=this.outputPictureWidth();var height=this.outputPictureHeight();return width*height*4};H264bsdDecoder.prototype.croppingParams=function(){var module=this.module;var pStorage=this.pStorage;var pCroppingFlag=module._malloc(4);var pLeftOffset=module._malloc(4);var pWidth=module._malloc(4);var pTopOffset=module._malloc(4);var pHeight=module._malloc(4);module._h264bsdCroppingParams(pStorage,pCroppingFlag,pLeftOffset,pWidth,pTopOffset,pHeight);var croppingFlag=module.getValue(pCroppingFlag,"i32");var leftOffset=module.getValue(pLeftOffset,"i32");var width=module.getValue(pWidth,"i32");var topOffset=module.getValue(pTopOffset,"i32");var height=module.getValue(pHeight,"i32");module._free(pCroppingFlag);module._free(pLeftOffset);module._free(pWidth);module._free(pTopOffset);module._free(pHeight);if(croppingFlag===0)return null;return{width:width,height:height,top:topOffset,left:leftOffset}};try{var decoder=new H264bsdDecoder(Module);addEventListener("message",function(e){decoder.queueInput(e.data)})}catch(e){postMessage({statusCode:H264bsdDecoder.ERROR})}